<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Crossfilter Test</title>
		<style>
			.chart div {
				font: 10px sans-serif;
				background-color: steelblue;
				text-align: right;
				padding: 3px;
				margin: 1px;
				color: white;
			}
		</style>
		<script src="crossfilter.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
	</head>

	<body>
		<h1>TTL Value Required to Reach Several Sites in China</h1>
		<h3>Histogram of TTL Values</h3>
		<div class="chart"></div>
		<br />
		<h3>Sites</h3>
		<div class="list"></div>
		<script type="text/javascript">
			d3.json("gcprobe.json", function(error, jsondata) {
				// facts
				var jsfiles = crossfilter(jsondata);

				// dimensions
				var ttlDimension = jsfiles.dimension(function(d) { return d.ttlrequired; });
				var domainDimension = jsfiles.dimension(function(d) {
					var url_parts = d.script.split('/');
					return url_parts[2];
				});

				// bar chart
				function updateChart() {
					var frequencyMeasure = ttlDimension.group().reduceCount();
					var result = frequencyMeasure.all();
					var c = d3.select(".chart")
						.selectAll("div")
							.data(result);
					c.enter().append("div")
						.text(function(d) { return d.key; })
						.on('mouseover', function(d) {
							this.style.backgroundColor = 'red';
							ttlDimension.filter(d.key);
							updateList();
						})
						.on('mouseleave', function(d) {
							this.style.backgroundColor = 'steelblue';
							ttlDimension.filterAll();
							updateList();
						});
					c.style("width", function(d) { return (d.value+10) + "px"; })
				};

				// list of domains
				function updateList() {
					var domains = domainDimension.group().reduceCount().all().filter(function(d) { return d.value > 0; });
					var l = d3.select(".list")
						.selectAll("div")
							.data(domains, function(d) { return d.key; });
					l.enter().append("div")
						.text(function(d) { return d.key; })
						.on('mouseover', function(d) {
							this.style.backgroundColor = 'red';
							domainDimension.filter(d.key);
							updateChart();
						})
						.on('mouseleave', function() {
							this.style.backgroundColor = '';
							domainDimension.filterAll();
							updateChart();
						});
					l.exit().remove();
				};

				updateChart();
				updateList();
			});
		</script>
	</body>

</html>
